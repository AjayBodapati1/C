package com.example.desis_to_csv;

import org.springframework.core.io.InputStreamResource;
import org.springframework.core.io.Resource;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

import java.io.*;
import java.util.*;

@RestController
public class FileConversionController {

    @GetMapping("/download-csv")
    public ResponseEntity<Resource> convertDesisToCsvAndDownload() throws IOException {

        String inputFilePath = "C:/downloads/file.qso";
        List<Map<String, String>> records = new ArrayList<>();

        // Read and parse DESIS format
        try (BufferedReader reader = new BufferedReader(new FileReader(inputFilePath))) {
            String line;

            while ((line = reader.readLine()) != null) {
                if (line.contains(":")) {
                    String[] segments = line.split("\\*");
                    Map<String, String> row = new LinkedHashMap<>();

                    for (String segment : segments) {
                        String[] kv = segment.split(":", 2);
                        if (kv.length == 2) {
                            row.put(kv[0].trim(), kv[1].trim());
                        }
                    }

                    if (!row.isEmpty()) {
                        records.add(row);
                    }
                }
            }
        }

        // Collect all possible headers
        Set<String> headersSet = new LinkedHashSet<>();
        for (Map<String, String> map : records) {
            headersSet.addAll(map.keySet());
        }
        List<String> headers = new ArrayList<>(headersSet);

        // Write CSV to memory
        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();
        try (PrintWriter writer = new PrintWriter(byteArrayOutputStream)) {
            writer.println(String.join(",", headers));
            for (Map<String, String> map : records) {
                List<String> values = new ArrayList<>();
                for (String header : headers) {
                    values.add(map.getOrDefault(header, ""));
                }
                writer.println(String.join(",", values));
            }
        }

        ByteArrayInputStream inputStream = new ByteArrayInputStream(byteArrayOutputStream.toByteArray());
        InputStreamResource resource = new InputStreamResource(inputStream);

        return ResponseEntity.ok()
                .header(HttpHeaders.CONTENT_DISPOSITION, "attachment; filename=outputpath.csv")
                .contentType(MediaType.parseMediaType("text/csv"))
                .contentLength(byteArrayOutputStream.size())
                .body(resource);
    }
}