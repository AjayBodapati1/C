package com.example.desis_to_csv;

import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.*;

@Service
public class FileMetadataService {

    public Map<String, Object> extractMetadata(MultipartFile file) {
        Map<String, Object> metadata = new HashMap<>();

        String filename = file.getOriginalFilename();
        String fileType = file.getContentType();
        String entityCode = (filename != null && filename.length() >= 6)
                ? filename.substring(0, 6)
                : "UNKNOWN";

        String uploadTime = LocalDateTime.now().format(DateTimeFormatter.ofPattern("dd/MM/yyyy HH:mm"));

        double fileSizeKB = file.getSize() / 1024.0;
        String formattedSize = String.format("%.2f KB", fileSizeKB);

        metadata.put("filename", filename);
        metadata.put("uploadTime", uploadTime);
        metadata.put("entityCode", entityCode);
        metadata.put("fileType", fileType);
        metadata.put("fileSize", formattedSize);

        if (fileType != null && fileType.contains("csv")) {
            try (BufferedReader reader = new BufferedReader(new InputStreamReader(file.getInputStream()))) {
                String headerLine = reader.readLine();
                if (headerLine != null) {
                    List<String> headers = Arrays.asList(headerLine.split(","));
                    metadata.put("headers", headers);
                }
            } catch (Exception e) {
                metadata.put("csvHeaderError", "Failed to read headers: " + e.getMessage());
            }
        }

        return metadata;
    }
}